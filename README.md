# Zaga Backend

Backend API para el sistema de gesti√≥n de pr√©stamos Zaga, construido con NestJS, TypeScript y Prisma.

## üöÄ Stack Tecnol√≥gico

- **NestJS 10** + **TypeScript** + **Prisma ORM**
- **PostgreSQL** (Supabase) + **Redis** + **BullMQ**
- **Autenticaci√≥n JWT** con **RLS (Row Level Security)**
- **Swagger/OpenAPI** + **Docker** + **Railway**

## üõ†Ô∏è Instalaci√≥n R√°pida

```bash
# 1. Clonar e instalar
git clone <repository-url>
cd zaga-backend
npm install

# 2. Configurar variables de entorno
cp env.example .env
# Editar .env con tus valores

# 3. Configurar base de datos
npx prisma generate
npx prisma db push

# 4. Ejecutar
npm run start:dev
```

### Variables de Entorno Principales

```env
DATABASE_URL=postgresql://...
REDIS_URL=redis://...
SUPABASE_PROJECT_URL=https://...
SUPABASE_ANON_KEY=...
SUPABASE_SERVICE_ROLE_KEY=...
```

## üìö API Documentation

- **Swagger UI**: http://localhost:3000/docs
- **Health Check**: http://localhost:3000/salud

## üîê Autenticaci√≥n

### Sistema JWT con Supabase + RLS

1. **Frontend** env√≠a JWT en `Authorization: Bearer <token>`
2. **SupabaseJwtGuard** verifica token con JWKS
3. **RLS** aplica pol√≠ticas autom√°ticamente basadas en `auth.jwt()`

### Roles Disponibles

- **admin**: Acceso completo al sistema
- **cliente**: Solo sus propios datos (RLS aplicado)

> **Nota**: Se simplific√≥ el sistema de roles eliminando `analista` y `cobranzas` para mayor simplicidad y mantenibilidad.

## üèóÔ∏è Arquitectura

### M√≥dulos Principales

- **`clientes/`** - Gesti√≥n de clientes
- **`solicitudes/`** - Solicitudes de pr√©stamos (RLS)
- **`prestamos/`** - Pr√©stamos aprobados (RLS)
- **`pagos/`** - Gesti√≥n de pagos
- **`evaluaciones/`** - Evaluaciones crediticias
- **`usuarios/`** - Informaci√≥n de usuarios (RLS)
- **`verificacion-identidad/`** - Documentos de identidad
- **`fuentes-externas/`** - Integraci√≥n BCRA/AFIP
- **`jobs/`** - Procesamiento as√≠ncrono BullMQ

### Servicios Compartidos

- **PrismaService** - ORM global
- **AuditService** - Trazabilidad completa
- **Logger** - Sistema de logging con Pino
- **RedisProvider** - Cache distribuido

## üîÑ Endpoints Principales

### Salud

- `GET /salud` - Estado de la aplicaci√≥n

### Clientes

- `GET /clientes` - Listar clientes (admin, analista)
- `POST /clientes` - Crear cliente (admin, analista)
- `GET /clientes/:id` - Obtener cliente (admin, analista)

### Solicitudes (RLS)

- `GET /solicitudes` - Listar solicitudes (RLS aplicado)
- `POST /solicitudes` - Crear solicitud (cliente_id del JWT)
- `POST /solicitudes/:id/evaluar` - Iniciar evaluaci√≥n (admin, analista)
- `POST /solicitudes/:id/garantes` - Agregar garante

### Pr√©stamos (RLS)

- `GET /prestamos` - Listar pr√©stamos (RLS aplicado)
- `GET /prestamos/:id` - Obtener pr√©stamo (RLS aplicado)

### Usuarios (RLS) - **MEJORADO** üî•

- `GET /usuarios` - Listar usuarios paginados (admin)
- `GET /usuarios/yo` - Mi perfil (admin, cliente)
- `GET /usuarios/:id` - Usuario espec√≠fico (admin)
- `PUT /usuarios/yo` - Actualizar mi perfil (admin, cliente)
- `DELETE /usuarios/:id` - Desactivar usuario (admin)
- `POST /usuarios/crear-perfil` - Crear perfil con verificaci√≥n de email
- `POST /usuarios/verificar-email` - Verificar email con token
- `POST /usuarios/reenviar-verificacion` - Reenviar verificaci√≥n
- `PUT /usuarios/:id/cambiar-email` - Cambiar email (admin)

### Verificaci√≥n de Identidad

- `POST /verificacion-identidad/:personaId/documentos` - Subir documento
- `GET /verificacion-identidad/:personaId/documentos` - Listar documentos

### Fuentes Externas

- `GET /bcra/:personaId/situacion` - Consultar BCRA (admin, staff)

## ‚öôÔ∏è Funcionalidades por Rol

### Clientes

- ‚úÖ Crear y actualizar su perfil personal
- ‚úÖ Verificar su email de registro
- ‚úÖ Crear solicitudes de pr√©stamo
- ‚úÖ Ver sus propias solicitudes y pr√©stamos
- ‚úÖ Subir documentos de identidad
- ‚úÖ Agregar garantes a sus solicitudes

### Administradores

- ‚úÖ Acceso completo a todos los m√≥dulos
- ‚úÖ Gesti√≥n completa de usuarios (listar, ver, desactivar)
- ‚úÖ Cambiar emails de usuarios (con verificaci√≥n)
- ‚úÖ Auditor√≠a completa del sistema
- ‚úÖ Gesti√≥n de solicitudes y evaluaciones
- ‚úÖ Consultar fuentes externas (BCRA)

## üîÑ Sistema de Colas (BullMQ)

### Procesamiento As√≠ncrono

- **Cola de evaluaci√≥n**: `evaluacion`
- **Jobs**: `consulta_fuente:BCRA`, `consolidar_evaluacion`
- **Integraci√≥n BCRA**: Consulta situaci√≥n crediticia en background

## üß™ Testing

```bash
npm run test          # Tests unitarios
npm run test:watch    # Tests en modo watch
npm run test:cov      # Coverage
npm run test:e2e      # Tests end-to-end
```

## üìù Scripts Principales

```bash
# Desarrollo
npm run start:dev     # Modo desarrollo con hot reload
npm run start:debug   # Modo debug

# Producci√≥n
npm run build         # Compilar TypeScript
npm run start         # Ejecutar compilado

# Base de datos
npm run prisma:generate    # Generar cliente Prisma
npm run prisma:migrate:deploy  # Aplicar migraciones
npm run prisma:studio      # Abrir Prisma Studio

# Calidad de c√≥digo
npm run lint          # ESLint con auto-fix
npm run format        # Prettier
```

## üöÄ Despliegue

### Railway (Recomendado)

1. Conecta tu repositorio a Railway
2. Configura las variables de entorno
3. Railway detectar√° autom√°ticamente el `Dockerfile`

### Docker

```bash
# Desarrollo
docker-compose -f docker-compose.dev.yml up

# Producci√≥n
docker build -t zaga-backend .
docker run -p 3000:3000 --env-file .env zaga-backend
```

## üõ°Ô∏è Seguridad

### RLS (Row Level Security)

- **Seguridad a nivel de fila** autom√°tica con Supabase
- **Pol√≠ticas granulares** por rol y cliente
- **Prevenci√≥n de manipulaci√≥n** de cliente_id (server-side)

### Sistema de Verificaci√≥n de Email üîê

- **Verificaci√≥n obligatoria** de email al crear perfil
- **Tokens seguros** con expiraci√≥n de 24 horas
- **Email no modificable** por usuarios (solo admins)
- **Reenv√≠o de verificaci√≥n** para emails no verificados
- **Auditor√≠a completa** de cambios de email

### Validaciones Robustas ‚úÖ

- **Edad m√≠nima**: 18 a√±os para pr√©stamos
- **Tel√©fono argentino**: Formato +549XXXXXXXX
- **Documentos √∫nicos**: Prevenci√≥n de duplicados
- **Validaci√≥n autom√°tica**: DTOs con class-validator
- **Transformaci√≥n de datos**: Autom√°tica con ValidationPipe

### Auditor√≠a

- **Registro completo** de todas las acciones
- **Metadatos**: Usuario, IP, User-Agent, timestamp
- **Trazabilidad** en entidades cr√≠ticas
- **Soft delete**: Mantiene historial de usuarios

## üöÄ Mejoras Recientes (v2.0)

### Sistema de Usuarios Completamente Renovado

- ‚úÖ **Paginaci√≥n inteligente** en listado de usuarios
- ‚úÖ **Validaciones robustas** con class-validator
- ‚úÖ **Sistema de verificaci√≥n de email** con tokens seguros
- ‚úÖ **Soft delete** para mantener historial
- ‚úÖ **Validaciones espec√≠ficas para Argentina** (tel√©fono, edad)
- ‚úÖ **Endpoints RESTful** completos (CRUD)

### Seguridad Mejorada

- ‚úÖ **Email no modificable** por usuarios regulares
- ‚úÖ **Verificaci√≥n obligatoria** de email
- ‚úÖ **Tokens criptogr√°ficos** con expiraci√≥n
- ‚úÖ **Prevenci√≥n de duplicados** en documentos
- ‚úÖ **Validaci√≥n de edad m√≠nima** (18 a√±os)

### Arquitectura Optimizada

- ‚úÖ **ValidationPipe global** para validaci√≥n autom√°tica
- ‚úÖ **DTOs tipados** con documentaci√≥n Swagger
- ‚úÖ **Servicios modulares** para mejor mantenibilidad
- ‚úÖ **Manejo de errores** consistente con c√≥digos HTTP apropiados

## üìö Documentaci√≥n

### **Documentos Principales:**
- [`ARQUITECTURA_TABLAS_USUARIOS.md`](docs/ARQUITECTURA_TABLAS_USUARIOS.md) - Arquitectura completa del sistema de usuarios
- [`FLUJO_VERIFICACION_EMAIL.md`](docs/FLUJO_VERIFICACION_EMAIL.md) - **NUEVO** - Flujo seguro de verificaci√≥n de email
- [`REGLAS_SISTEMA_USUARIOS.md`](docs/REGLAS_SISTEMA_USUARIOS.md) - Reglas y validaciones del sistema
- [`CONFIGURACION_BASE_DATOS.md`](docs/CONFIGURACION_BASE_DATOS.md) - Configuraci√≥n de base de datos
- [`MIGRACION_EMAIL_PRODUCCION.md`](docs/MIGRACION_EMAIL_PRODUCCION.md) - Migraci√≥n a producci√≥n

### **Scripts de Utilidad:**
```bash
# Verificar configuraci√≥n de SendGrid
node scripts/check-sendgrid-config.js

# Probar nuevo flujo de verificaci√≥n
node scripts/test-new-user-flow.js

# Limpiar datos de prueba
node scripts/cleanup-test-data.js

# Limpiar todo el sistema
node scripts/cleanup-all-users.js
```

## üìà Escalabilidad

- **Arquitectura modular** para f√°cil mantenimiento
- **Procesamiento as√≠ncrono** con BullMQ
- **Cache distribuido** con Redis
- **Logging estructurado** para monitoreo

## ü§ù Contribuci√≥n

1. Fork el proyecto
2. Crea una rama (`git checkout -b feature/AmazingFeature`)
3. Commit tus cambios (`git commit -m 'Add some AmazingFeature'`)
4. Push a la rama (`git push origin feature/AmazingFeature`)
5. Abre un Pull Request

### Est√°ndares

- Sigue los principios **SOLID**
- Usa **TypeScript** con tipado estricto
- Aplica **BEM** si ayuda a la claridad
- Sigue las recomendaciones de **ESLint**

## üìÑ Licencia

Este proyecto es privado y confidencial.

## üÜò Soporte

Para soporte t√©cnico, contacta al equipo de desarrollo.
