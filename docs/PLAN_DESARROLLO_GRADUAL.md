# üöÄ Plan de Desarrollo Gradual - Zaga Backend

## üìä An√°lisis del Proyecto Actual

### ‚úÖ **Fortalezas del Backend Existente**
- **Arquitectura s√≥lida**: NestJS 10 + TypeScript + Prisma ORM
- **Seguridad robusta**: JWT con Supabase + RLS (Row Level Security)
- **Escalabilidad**: Redis, BullMQ para procesamiento as√≠ncrono
- **Auditor√≠a completa**: Sistema de trazabilidad con metadatos
- **Modularidad**: 9 m√≥dulos bien estructurados
- **Base de datos compleja**: 12 tablas con relaciones financieras
- **Documentaci√≥n**: Swagger/OpenAPI integrado
- **Testing**: Jest configurado para unitarios y e2e

### ‚ö†Ô∏è **Complejidad Actual**
- **9 m√≥dulos** (clientes, solicitudes, pr√©stamos, pagos, evaluaciones, etc.)
- **12 tablas** en la base de datos
- **Sistema de roles complejo** (admin, analista, cobranzas, cliente)
- **Integraci√≥n BCRA/AFIP** para consultas crediticias
- **Sistema de colas** para procesamiento as√≠ncrono

### üéØ **Cambio Propuesto: Simplificaci√≥n de Roles**
**Eliminar roles innecesarios:**
- ‚ùå `analista` - Funcionalidad se integra en `admin`
- ‚ùå `cobranzas` - Funcionalidad se integra en `admin`
- ‚úÖ `admin` - Acceso completo al sistema
- ‚úÖ `cliente` - Solo sus propios datos (RLS aplicado)

## üõ†Ô∏è Plan de Desarrollo Gradual

### **Fase 1: MVP de Autenticaci√≥n (Semanas 1-2)**

#### **Objetivo**
Implementar solo la autenticaci√≥n b√°sica con Supabase y un dashboard m√≠nimo.

#### **M√≥dulos Necesarios**
```typescript
// app.module.ts - Solo estos m√≥dulos:
- ConfigModule (ya existe)
- LoggerModule (ya existe) 
- AuthModule (ya existe)
- PrismaModule (ya existe)
- RedisModule (ya existe)
- SaludModule (ya existe)
- UsuariosModule (simplificado)
```

#### **Base de Datos M√≠nima**
```sql
-- Solo estas tablas necesarias:
- seguridad.usuarios (user_id, persona_id, rol, estado)
- financiera.personas (datos b√°sicos del usuario)
- financiera.auditoria (logs b√°sicos)
```

#### **Endpoints B√°sicos**
```bash
GET  /salud                    # Health check
GET  /usuarios                 # Listar usuarios (admin) - Dashboard admin
GET  /usuarios/yo             # Perfil del usuario autenticado
POST /usuarios/crear-perfil   # Crear perfil al registrarse (cliente)
```

#### **Flujo de Usuario en Fase 1**
```mermaid
graph TD
    A[Usuario se registra en Frontend] --> B[POST /usuarios/crear-perfil]
    B --> C[Usuario se loguea con Supabase]
    C --> D{¬øEs Admin o Cliente?}
    D -->|Admin| E[GET /usuarios - Ver todos los clientes]
    D -->|Cliente| F[GET /usuarios/yo - Ver su perfil]
    E --> G[Dashboard Admin]
    F --> H[Dashboard Cliente]
```

#### **Tareas Espec√≠ficas**
- [ ] Simplificar `roles.guard.ts` (solo admin/cliente)
- [ ] Crear `UsuariosModule` b√°sico
- [ ] Implementar endpoint `GET /usuarios` (solo admin)
- [ ] Implementar endpoint `GET /usuarios/yo` (cliente/admin)
- [ ] Implementar endpoint `POST /usuarios/crear-perfil` (registro)
- [ ] Configurar RLS b√°sico en Supabase
- [ ] Crear migraci√≥n de base de datos simplificada

### **Fase 2: Gesti√≥n de Clientes (Semanas 3-4)**

#### **Objetivo**
Permitir que los clientes gestionen su informaci√≥n b√°sica.

#### **M√≥dulos Agregados**
```typescript
- ClientesModule (simplificado)
```

#### **Base de Datos**
```sql
-- Agregar:
- financiera.clientes
- financiera.documentos_identidad (b√°sico)
```

#### **Endpoints**
```bash
GET    /clientes/yo           # Mis datos como cliente
PUT    /clientes/yo           # Actualizar mis datos
POST   /clientes/documentos   # Subir documento de identidad
GET    /clientes/documentos   # Ver mis documentos
```

#### **Tareas Espec√≠ficas**
- [ ] Implementar `ClientesController` b√°sico
- [ ] Crear DTOs para actualizaci√≥n de perfil
- [ ] Implementar subida de documentos
- [ ] Configurar pol√≠ticas RLS para clientes

### **Fase 3: Solicitudes de Pr√©stamos (Semanas 5-6)**

#### **Objetivo**
Permitir que los clientes soliciten pr√©stamos y los admins los gestionen.

#### **M√≥dulos Agregados**
```typescript
- SolicitudesModule
- GarantesModule (b√°sico)
```

#### **Base de Datos**
```sql
-- Agregar:
- financiera.solicitudes
- financiera.garantes
- financiera.solicitud_garantes
```

#### **Endpoints Cliente**
```bash
POST   /solicitudes           # Crear solicitud
GET    /solicitudes           # Ver mis solicitudes
GET    /solicitudes/:id       # Ver detalle de solicitud
POST   /solicitudes/:id/garantes # Agregar garante
```

#### **Endpoints Admin**
```bash
GET    /admin/solicitudes     # Ver todas las solicitudes
PUT    /admin/solicitudes/:id # Actualizar estado
GET    /admin/solicitudes/:id # Ver detalle completo
```

### **Fase 4: Evaluaciones y Pr√©stamos (Semanas 7-8)**

#### **Objetivo**
Implementar el proceso de evaluaci√≥n y aprobaci√≥n de pr√©stamos.

#### **M√≥dulos Agregados**
```typescript
- EvaluacionesModule
- PrestamosModule
```

#### **Base de Datos**
```sql
-- Agregar:
- financiera.evaluaciones
- financiera.prestamos
- financiera.cronogramas
```

#### **Endpoints Admin**
```bash
POST   /admin/solicitudes/:id/evaluar    # Iniciar evaluaci√≥n
PUT    /admin/evaluaciones/:id           # Actualizar evaluaci√≥n
POST   /admin/solicitudes/:id/aprobar    # Aprobar pr√©stamo
GET    /admin/prestamos                  # Ver todos los pr√©stamos
```

#### **Endpoints Cliente**
```bash
GET    /prestamos                        # Ver mis pr√©stamos
GET    /prestamos/:id                    # Ver detalle de pr√©stamo
GET    /prestamos/:id/cronograma         # Ver cronograma de pagos
```

### **Fase 5: Sistema de Pagos (Semanas 9-10)**

#### **Objetivo**
Implementar el sistema de pagos y seguimiento.

#### **M√≥dulos Agregados**
```typescript
- PagosModule
```

#### **Base de Datos**
```sql
-- Agregar:
- financiera.pagos
```

#### **Endpoints**
```bash
# Cliente
GET    /pagos                           # Ver mis pagos
POST   /pagos                           # Registrar pago

# Admin
GET    /admin/pagos                     # Ver todos los pagos
PUT    /admin/pagos/:id                 # Actualizar estado de pago
```

### **Fase 6: Funcionalidades Avanzadas (Semanas 11-12)**

#### **Objetivo**
Agregar funcionalidades avanzadas seg√∫n necesidad.

#### **M√≥dulos Opcionales**
```typescript
- FuentesExternasModule (BCRA/AFIP)
- JobsModule (procesamiento as√≠ncrono)
- VerificacionIdentidadModule (avanzado)
```

## üîß **Modificaciones Necesarias en el C√≥digo Actual**

### **1. Simplificar Sistema de Roles**

#### **Archivo: `src/config/roles.decorator.ts`**
```typescript
// Cambiar de:
export const Roles = (...roles: string[]) => SetMetadata('roles', roles);

// A:
export const Roles = (...roles: ('admin' | 'cliente')[]) => SetMetadata('roles', roles);
```

#### **Archivo: `src/config/roles.guard.ts`**
```typescript
// Simplificar validaci√≥n para solo admin/cliente
const validRoles = ['admin', 'cliente'];
```

### **2. Actualizar Base de Datos**

#### **Archivo: `prisma/schema.prisma`**
```prisma
// Simplificar tabla de usuarios
model seguridad_usuarios {
  user_id     String   @id @db.Uuid
  persona_id  String?  @db.Uuid
  rol         String   @default("cliente") // Solo "admin" o "cliente"
  estado      String   @default("activo")
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  updated_at  DateTime @updatedAt @db.Timestamptz(6)

  @@map("seguridad.usuarios")
}
```

### **3. Simplificar App Module**

#### **Archivo: `src/app.module.ts`**
```typescript
@Module({
  imports: [
    // Configuraci√≥n b√°sica
    ConfigModule.forRoot({...}),
    LoggerModule.forRootAsync({...}),
    
    // Servicios compartidos
    AuthModule,
    PrismaModule,
    RedisModule,
    
    // M√≥dulos b√°sicos
    SaludModule,
    UsuariosModule, // Nuevo m√≥dulo simplificado
    
    // M√≥dulos adicionales se agregan gradualmente
    // ClientesModule,    // Fase 2
    // SolicitudesModule, // Fase 3
    // etc...
  ],
})
export class AppModule {}
```

## üìã **Checklist de Implementaci√≥n**

### **Preparaci√≥n (D√≠a 1)**
- [ ] Crear rama `feature/simplified-roles`
- [ ] Actualizar documentaci√≥n de roles
- [ ] Crear migraci√≥n para simplificar roles
- [ ] Actualizar tests existentes

### **Fase 1 - MVP (Semanas 1-2)**
- [ ] Simplificar `roles.guard.ts`
- [ ] Crear `UsuariosModule` b√°sico
- [ ] Implementar endpoint `/usuarios/yo`
- [ ] Configurar RLS en Supabase
- [ ] Crear tests b√°sicos
- [ ] Documentar API con Swagger

### **Fase 2 - Clientes (Semanas 3-4)**
- [ ] Implementar `ClientesModule`
- [ ] Crear DTOs para perfil de cliente
- [ ] Implementar subida de documentos
- [ ] Configurar pol√≠ticas RLS
- [ ] Tests de integraci√≥n

### **Fase 3 - Solicitudes (Semanas 5-6)**
- [ ] Implementar `SolicitudesModule`
- [ ] Crear `GarantesModule` b√°sico
- [ ] Implementar endpoints de cliente
- [ ] Implementar endpoints de admin
- [ ] Tests end-to-end

### **Fase 4 - Pr√©stamos (Semanas 7-8)**
- [ ] Implementar `EvaluacionesModule`
- [ ] Implementar `PrestamosModule`
- [ ] Crear sistema de cronogramas
- [ ] Implementar aprobaci√≥n de pr√©stamos
- [ ] Tests de flujo completo

### **Fase 5 - Pagos (Semanas 9-10)**
- [ ] Implementar `PagosModule`
- [ ] Crear sistema de seguimiento
- [ ] Implementar notificaciones b√°sicas
- [ ] Tests de pagos

### **Fase 6 - Avanzado (Semanas 11-12)**
- [ ] Evaluar necesidad de m√≥dulos avanzados
- [ ] Implementar seg√∫n prioridades
- [ ] Optimizaci√≥n y performance
- [ ] Documentaci√≥n final

## üéØ **Ventajas del Plan Gradual**

### **Para el Aprendizaje**
- ‚úÖ **Progresi√≥n natural**: Cada fase construye sobre la anterior
- ‚úÖ **Comprensi√≥n profunda**: Entiendes cada pieza antes de agregar complejidad
- ‚úÖ **Debugging m√°s f√°cil**: Problemas m√°s localizados y manejables

### **Para el Desarrollo**
- ‚úÖ **Desarrollo m√°s r√°pido**: Menos c√≥digo = menos bugs
- ‚úÖ **Feedback temprano**: Puedes probar funcionalidades b√°sicas r√°pidamente
- ‚úÖ **Flexibilidad**: Puedes ajustar el plan seg√∫n necesidades reales

### **Para el Negocio**
- ‚úÖ **Menor costo inicial**: Menos recursos de infraestructura
- ‚úÖ **Time-to-market**: Funcionalidades b√°sicas disponibles antes
- ‚úÖ **Escalabilidad real**: Agregas funcionalidades seg√∫n demanda real

## üöÄ **Pr√≥ximos Pasos**

1. **Crear rama de desarrollo**: `git checkout -b feature/simplified-roles`
2. **Simplificar sistema de roles** seg√∫n especificaciones
3. **Implementar Fase 1** (MVP de autenticaci√≥n)
4. **Crear frontend b√°sico** para probar autenticaci√≥n
5. **Iterar** seg√∫n el plan gradual

---

**Nota**: Este plan mantiene la arquitectura s√≥lida del proyecto actual pero simplifica la complejidad inicial, permitiendo un desarrollo m√°s manejable y un aprendizaje progresivo.
