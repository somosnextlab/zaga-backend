# Autenticaci√≥n en Swagger

## Descripci√≥n

Este documento explica c√≥mo usar el sistema de autenticaci√≥n para probar los endpoints en Swagger en diferentes entornos.

## üîí **Seguridad por Entorno**

### **Desarrollo Local**
- ‚úÖ Usa JWT locales generados por `/auth/login`
- ‚úÖ Credenciales de desarrollo para testing
- ‚úÖ Acceso autom√°tico sin token (modo desarrollo)

### **Producci√≥n (Railway)**
- üîí **Solo Supabase Auth** - M√°xima seguridad
- üîí Tokens validados criptogr√°ficamente
- üîí Rotaci√≥n autom√°tica de claves
- üîí Auditor√≠a y monitoreo completo

## Endpoints Disponibles

### 1. Salud del Sistema (Sin Autenticaci√≥n)
- **URL**: `GET /salud`
- **Descripci√≥n**: Verifica el estado del sistema
- **Autenticaci√≥n**: No requerida
- **Uso**: Ideal para verificar que el backend est√© funcionando

### 2. Autenticaci√≥n
- **URL**: `POST /auth/login`
- **Descripci√≥n**: Obtiene un token JWT para autenticaci√≥n
- **Autenticaci√≥n**: No requerida
- **Body**:
  ```json
  {
    "email": "usuario@ejemplo.com",
    "password": "miPassword123"
  }
  ```

## Credenciales de Desarrollo

Para testing, se han configurado las siguientes credenciales:

| Email | Password | Rol | Descripci√≥n |
|-------|----------|-----|-------------|
| `admin@zaga.com` | `admin123` | admin | Usuario administrador |
| `cliente@zaga.com` | `cliente123` | cliente | Usuario cliente |
| `test@zaga.com` | `test123` | cliente | Usuario de prueba |

## C√≥mo Usar en Swagger

1. **Acceder a Swagger**: Ve a `http://localhost:3000/api/docs`

2. **Probar endpoint de salud**: 
   - Busca el endpoint `GET /salud`
   - Haz clic en "Try it out"
   - Ejecuta la petici√≥n (no requiere autenticaci√≥n)

3. **Obtener token de autenticaci√≥n**:
   - Busca el endpoint `POST /auth/login`
   - Haz clic en "Try it out"
   - Ingresa las credenciales en el body:
     ```json
     {
       "email": "admin@zaga.com",
       "password": "admin123"
     }
     ```
   - Ejecuta la petici√≥n
   - Copia el `access_token` de la respuesta

4. **Autorizar en Swagger**:
   - Haz clic en el bot√≥n "Authorize" (üîí) en la parte superior de Swagger
   - Pega el token en el campo "Value"
   - Haz clic en "Authorize"
   - Cierra el modal

5. **Probar endpoints protegidos**:
   - Ahora puedes probar cualquier endpoint que requiera autenticaci√≥n
   - El token se incluir√° autom√°ticamente en las peticiones

## Respuesta del Login

```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "Bearer",
  "expires_in": 86400,
  "user": {
    "user_id": "550e8400-e29b-41d4-a716-446655440000",
    "email": "admin@zaga.com",
    "rol": "admin"
  }
}
```

## Configuraci√≥n de Variables de Entorno

Aseg√∫rate de tener estas variables en tu archivo `.env`:

```env
# JWT Configuration
JWT_SECRET=tu_clave_secreta_jwt_aqui
JWT_EXPIRES_IN=24h
```

## Notas Importantes

- Los tokens JWT tienen una duraci√≥n de 24 horas por defecto
- En modo desarrollo, el sistema acepta tanto tokens JWT locales como tokens de Supabase
- Si no hay configuraci√≥n de Supabase, el sistema usa JWT locales para autenticaci√≥n
- Las credenciales de desarrollo son solo para testing, no para producci√≥n
- El endpoint de salud no requiere autenticaci√≥n para facilitar el monitoreo del sistema
- El token generado por `/auth/login` es compatible con todos los endpoints protegidos

## Soluci√≥n de Problemas

### Error "Token inv√°lido o expirado"
Si recibes este error despu√©s de usar el token del endpoint `/auth/login`:

1. **Verifica que est√©s en modo desarrollo**: El sistema debe estar configurado sin Supabase
2. **Revisa la configuraci√≥n**: Aseg√∫rate de que `SUPABASE_PROJECT_URL` no est√© configurado o sea `https://example.supabase.co`
3. **Token expirado**: Los tokens duran 24 horas, genera uno nuevo si es necesario
4. **Formato del token**: Aseg√∫rate de incluir "Bearer " antes del token en Swagger

## üöÄ **Para Producci√≥n (Railway)**

### **Obtener Token de Supabase**

1. **Configura Supabase**:
   ```env
   SUPABASE_PROJECT_URL=https://tu-proyecto.supabase.co
   SUPABASE_JWKS_URL=https://tu-proyecto.supabase.co/auth/v1/keys
   ```

2. **Usa el SDK de Supabase**:
   ```javascript
   import { createClient } from '@supabase/supabase-js'
   
   const supabase = createClient(
     'https://tu-proyecto.supabase.co',
     'tu-anon-key'
   )
   
   const { data, error } = await supabase.auth.signInWithPassword({
     email: 'usuario@ejemplo.com',
     password: 'tu-password'
   })
   
   const token = data.session.access_token
   ```

3. **O desde la consola de Supabase**:
   - Ve a tu proyecto en [supabase.com](https://supabase.com)
   - Authentication ‚Üí Users
   - Genera un token de prueba

4. **Usa el token en Swagger**:
   - Formato: `Bearer <supabase_token>`
   - El token debe ser v√°lido y no expirado

### **Endpoint de Ayuda**
- `GET /auth/supabase-token` - Informaci√≥n sobre autenticaci√≥n con Supabase

### Modo de Funcionamiento
- **Desarrollo**: Usa JWT locales generados por `/auth/login`
- **Producci√≥n**: Usa tokens de Supabase para autenticaci√≥n (m√°xima seguridad)
