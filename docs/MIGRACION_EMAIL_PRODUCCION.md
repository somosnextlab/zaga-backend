# Migraci√≥n de Servicio de Email: Desarrollo a Producci√≥n

## üìã **Resumen Ejecutivo**

Este documento detalla la estrategia de migraci√≥n del servicio de email de Zaga desde la configuraci√≥n actual de desarrollo (Single Sender Verification con Gmail) hacia una configuraci√≥n de producci√≥n robusta utilizando Domain Authentication con el dominio `zaga.com.ar`.

---

## üéØ **Estado Actual (Fase 1: Desarrollo)**

### ‚úÖ **Configuraci√≥n Completada**

#### **1. Single Sender Verification**
- **Estado**: ‚úÖ **VERIFICADO** en SendGrid
- **From Name**: `Zaga - Next Lab`
- **From Email**: `somosnextlab@gmail.com`
- **Reply To**: `somosnextlab@gmail.com`
- **Nickname**: `Zaga - Next Lab - Sistema de Emails`
- **Direcci√≥n**: `Av. Corrientes 1234, C√≥rdoba, ARG`

#### **2. Servicio de Email Implementado**
- **SendGrid Package**: ‚úÖ Instalado (`@sendgrid/mail`)
- **EmailService**: ‚úÖ Creado en `src/shared/email.service.ts`
- **Templates HTML**: ‚úÖ Implementados (verificaci√≥n y cambio de email)
- **Integraci√≥n**: ‚úÖ Conectado a `UsuariosModule` y `UsuariosService`

#### **3. Variables de Entorno**
```env
SENDGRID_API_KEY=tu_api_key_real_aqui
FROM_EMAIL=somosnextlab@gmail.com
FROM_NAME=Zaga - Next Lab
FRONTEND_URL=https://zaga.com.ar
```

#### **4. Funcionalidades Activas**
- ‚úÖ **Crear perfil** ‚Üí Env√≠a email de verificaci√≥n
- ‚úÖ **Reenviar verificaci√≥n** ‚Üí Reenv√≠a email al usuario
- ‚úÖ **Cambiar email (admin)** ‚Üí Env√≠a notificaci√≥n al nuevo email
- ‚úÖ **Validaciones DTO** ‚Üí Formato argentino, edad m√≠nima, etc.

#### **5. Base de Datos**
- ‚úÖ **Tabla `seguridad_tokens_verificacion`** ‚Üí Creada y funcionando
- ‚úÖ **Campos `email_verificado`** ‚Üí Agregados a `seguridad_usuarios`
- ‚úÖ **Migraci√≥n aplicada** ‚Üí Prisma actualizado

---

## üöÄ **Configuraci√≥n Objetivo (Fase 2: Producci√≥n)**

### **Objetivo Principal**
Migrar a **Domain Authentication** con el dominio `zaga.com.ar` para:
- Eliminar "via sendgrid.net" de los emails
- Mejorar deliverabilidad y reputaci√≥n
- Establecer marca profesional de Zaga
- Cumplir con est√°ndares DMARC/DKIM/SPF

### **Configuraci√≥n Objetivo**
```env
FROM_EMAIL=noreply@zaga.com.ar
FROM_NAME=Zaga
FRONTEND_URL=https://zaga.com.ar
```

---

## üìã **Plan de Migraci√≥n Detallado**

### **Paso 1: Verificar Configuraci√≥n DNS Actual** ‚è≥

#### **Estado Actual de DNS en DonWeb**
Los siguientes registros ya est√°n configurados en DonWeb:

| Tipo | Nombre | Valor | Estado |
|------|--------|-------|--------|
| CNAME | url1929.zaga.com.ar | sendgrid.net | ‚úÖ Configurado |
| CNAME | 56661548.zaga.com.ar | sendgrid.net | ‚úÖ Configurado |
| CNAME | em7699.zaga.com.ar | u56661548.wl049.sendgrid.net | ‚úÖ Configurado |
| CNAME | s1._domainkey.zaga.com.ar | s1.domainkey.u56661548.wl049.sendgrid.net | ‚úÖ Configurado |
| CNAME | s2._domainkey.zaga.com.ar | s2.domainkey.u56661548.wl049.sendgrid.net | ‚úÖ Configurado |
| TXT | _dmarc.zaga.com.ar | v=DMARC1; p=none; | ‚úÖ Configurado |

#### **Acciones Requeridas**
- [ ] **Verificar propagaci√≥n DNS** (puede tomar hasta 48 horas)
- [ ] **Probar resoluci√≥n DNS** con herramientas online
- [ ] **Confirmar que todos los registros est√°n activos**

### **Paso 2: Configurar Domain Authentication en SendGrid** ‚è≥

#### **Acciones Requeridas**
- [ ] **Acceder a SendGrid** ‚Üí Settings ‚Üí Sender Authentication
- [ ] **Hacer clic en "Authenticate Your Domain"**
- [ ] **Ingresar dominio**: `zaga.com.ar`
- [ ] **Seleccionar DNS Host**: "Other Host (Not Listed)" ‚Üí "DonWeb"
- [ ] **Configurar Link Branding**: "No" (inicialmente)
- [ ] **Hacer clic en "Next"**
- [ ] **Verificar que SendGrid detecte los registros DNS existentes**
- [ ] **Hacer clic en "Verify"** para validar la configuraci√≥n

#### **Resultado Esperado**
- ‚úÖ **Domain Authentication**: Estado "VERIFIED"
- ‚úÖ **Link Branding**: Estado "VERIFIED" (opcional)

### **Paso 3: Actualizar Variables de Entorno** ‚è≥

#### **Archivo `.env` de Producci√≥n**
```env
# SendGrid Email Service (PRODUCCI√ìN)
SENDGRID_API_KEY=tu_api_key_real_aqui
FROM_EMAIL=noreply@zaga.com.ar
FROM_NAME=Zaga
FRONTEND_URL=https://zaga.com.ar
```

#### **Archivo `.env` de Desarrollo (Mantener)**
```env
# SendGrid Email Service (DESARROLLO)
SENDGRID_API_KEY=tu_api_key_real_aqui
FROM_EMAIL=somosnextlab@gmail.com
FROM_NAME=Zaga - Next Lab
FRONTEND_URL=https://zaga.com.ar
```

### **Paso 4: Verificar Funcionamiento** ‚è≥

#### **Pruebas Requeridas**
- [ ] **Crear perfil de usuario** ‚Üí Verificar que llegue email desde `noreply@zaga.com.ar`
- [ ] **Reenviar verificaci√≥n** ‚Üí Confirmar env√≠o correcto
- [ ] **Cambiar email (admin)** ‚Üí Verificar notificaci√≥n
- [ ] **Revisar logs** ‚Üí Confirmar que no hay errores de SendGrid
- [ ] **Verificar en SendGrid Activity Feed** ‚Üí Confirmar env√≠os exitosos

### **Paso 5: Limpieza (Opcional)** ‚è≥

#### **Single Sender Verification**
- [ ] **Evaluar si mantener** `somosnextlab@gmail.com` para pruebas internas
- [ ] **O eliminar** si ya no se necesita

---

## ‚ö†Ô∏è **Consideraciones Importantes**

### **Tiempo de Migraci√≥n**
- **DNS Propagation**: 15 minutos - 48 horas
- **SendGrid Verification**: Inmediato una vez propagado DNS
- **Testing**: 1-2 horas
- **Total estimado**: 1-3 d√≠as

### **Riesgos y Mitigaciones**
| Riesgo | Probabilidad | Impacto | Mitigaci√≥n |
|--------|-------------|---------|------------|
| DNS no se propaga | Baja | Alto | Monitorear con herramientas online |
| SendGrid no verifica | Media | Alto | Revisar registros DNS, contactar soporte |
| Emails no llegan | Baja | Alto | Mantener configuraci√≥n actual como backup |

### **Rollback Plan**
Si algo falla, revertir a configuraci√≥n actual:
```env
FROM_EMAIL=somosnextlab@gmail.com
FROM_NAME=Zaga - Next Lab
```

---

## üìä **Criterios de √âxito**

### **M√©tricas de Verificaci√≥n**
- [ ] **Domain Authentication**: Estado "VERIFIED" en SendGrid
- [ ] **Emails enviados**: Sin errores en logs
- [ ] **Deliverabilidad**: Emails llegan a inbox (no spam)
- [ ] **Marca**: Sin "via sendgrid.net" en destinatarios
- [ ] **Funcionalidad**: Todos los endpoints de email funcionan

### **Monitoreo Post-Migraci√≥n**
- **SendGrid Activity Feed**: Revisar env√≠os diarios
- **Logs de aplicaci√≥n**: Monitorear errores de email
- **Feedback de usuarios**: Confirmar recepci√≥n de emails

---

## üîß **Herramientas de Verificaci√≥n**

### **DNS Lookup**
```bash
# Verificar registros CNAME
nslookup url1929.zaga.com.ar
nslookup em7699.zaga.com.ar
nslookup s1._domainkey.zaga.com.ar

# Verificar registro TXT
nslookup -type=TXT _dmarc.zaga.com.ar
```

### **Herramientas Online**
- **MXToolbox**: https://mxtoolbox.com/
- **DNS Checker**: https://dnschecker.org/
- **SendGrid Activity Feed**: Panel de SendGrid

---

## üìù **Checklist de Migraci√≥n**

### **Pre-Migraci√≥n**
- [ ] Verificar que DNS est√© propagado
- [ ] Confirmar que SendGrid detecte los registros
- [ ] Preparar variables de entorno de producci√≥n
- [ ] Planificar ventana de mantenimiento

### **Durante la Migraci√≥n**
- [ ] Configurar Domain Authentication en SendGrid
- [ ] Actualizar variables de entorno
- [ ] Reiniciar aplicaci√≥n
- [ ] Ejecutar pruebas de funcionalidad

### **Post-Migraci√≥n**
- [ ] Verificar env√≠o de emails
- [ ] Monitorear logs por 24 horas
- [ ] Confirmar deliverabilidad
- [ ] Documentar resultados

---

## üìû **Contactos y Recursos**

### **SendGrid Support**
- **Documentaci√≥n**: https://docs.sendgrid.com/
- **Soporte**: Panel de SendGrid ‚Üí Support
- **Status Page**: https://status.sendgrid.com/

### **DonWeb Support**
- **Panel**: https://panel.donweb.com/
- **Soporte**: Para consultas sobre DNS

---

**Documento creado**: 10 de enero de 2025  
**√öltima actualizaci√≥n**: 10 de enero de 2025  
**Estado**: Listo para implementaci√≥n
