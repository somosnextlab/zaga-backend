# ==============================================
# EJEMPLOS DE POWERSHELL PARA PROBAR ENDPOINTS RLS
# ==============================================

# Configuraci√≥n
$BaseUrl = "http://localhost:3000"
# ‚ö†Ô∏è IMPORTANTE: Reemplaza estos tokens con tokens REALES de Supabase
$AdminToken = "TU_TOKEN_ADMIN_REAL_AQUI"
$ClienteToken = "TU_TOKEN_CLIENTE_REAL_AQUI"

Write-Host "üß™ PROBANDO ENDPOINTS RLS DE ZAGA BACKEND" -ForegroundColor Green
Write-Host "==========================================" -ForegroundColor Green

# ==============================================
# 1. PROBAR SIN TOKEN (deber√≠a devolver 401)
# ==============================================

Write-Host "`n1Ô∏è‚É£ Probando endpoints sin token (deber√≠a devolver 401):" -ForegroundColor Cyan

Write-Host "   GET /prestamos sin token:" -ForegroundColor Yellow
try {
    $response = Invoke-WebRequest -Uri "$BaseUrl/prestamos" -TimeoutSec 5
    Write-Host "   ‚ùå Error: Deber√≠a devolver 401" -ForegroundColor Red
} catch {
    if ($_.Exception.Response.StatusCode -eq 401) {
        Write-Host "   ‚úÖ 401 Unauthorized" -ForegroundColor Green
    } else {
        Write-Host "   ‚ùå Error inesperado: $($_.Exception.Message)" -ForegroundColor Red
    }
}

Write-Host "   GET /solicitudes sin token:" -ForegroundColor Yellow
try {
    $response = Invoke-WebRequest -Uri "$BaseUrl/solicitudes" -TimeoutSec 5
    Write-Host "   ‚ùå Error: Deber√≠a devolver 401" -ForegroundColor Red
} catch {
    if ($_.Exception.Response.StatusCode -eq 401) {
        Write-Host "   ‚úÖ 401 Unauthorized" -ForegroundColor Green
    } else {
        Write-Host "   ‚ùå Error inesperado: $($_.Exception.Message)" -ForegroundColor Red
    }
}

Write-Host "   GET /usuarios/yo sin token:" -ForegroundColor Yellow
try {
    $response = Invoke-WebRequest -Uri "$BaseUrl/usuarios/yo" -TimeoutSec 5
    Write-Host "   ‚ùå Error: Deber√≠a devolver 401" -ForegroundColor Red
} catch {
    if ($_.Exception.Response.StatusCode -eq 401) {
        Write-Host "   ‚úÖ 401 Unauthorized" -ForegroundColor Green
    } else {
        Write-Host "   ‚ùå Error inesperado: $($_.Exception.Message)" -ForegroundColor Red
    }
}

# ==============================================
# 2. PROBAR CON TOKEN INV√ÅLIDO (deber√≠a devolver 401)
# ==============================================

Write-Host "`n2Ô∏è‚É£ Probando endpoints con token inv√°lido (deber√≠a devolver 401):" -ForegroundColor Cyan

Write-Host "   GET /prestamos con token inv√°lido:" -ForegroundColor Yellow
$headers = @{ "Authorization" = "Bearer token-invalido" }
try {
    $response = Invoke-WebRequest -Uri "$BaseUrl/prestamos" -Headers $headers -TimeoutSec 5
    Write-Host "   ‚ùå Error: Deber√≠a devolver 401" -ForegroundColor Red
} catch {
    if ($_.Exception.Response.StatusCode -eq 401) {
        Write-Host "   ‚úÖ 401 Unauthorized" -ForegroundColor Green
    } else {
        Write-Host "   ‚ùå Error inesperado: $($_.Exception.Message)" -ForegroundColor Red
    }
}

# ==============================================
# 3. PROBAR CON TOKEN DE ADMIN
# ==============================================

Write-Host "`n3Ô∏è‚É£ Probando endpoints con token de ADMIN:" -ForegroundColor Cyan

Write-Host "   GET /prestamos (admin deber√≠a ver todos):" -ForegroundColor Yellow
$headers = @{ "Authorization" = "Bearer $AdminToken" }
try {
    $response = Invoke-WebRequest -Uri "$BaseUrl/prestamos" -Headers $headers -TimeoutSec 5
    Write-Host "   ‚úÖ Respuesta recibida - Status: $($response.StatusCode)" -ForegroundColor Green
    Write-Host "   Contenido: $($response.Content.Substring(0, [Math]::Min(100, $response.Content.Length)))..." -ForegroundColor Gray
} catch {
    Write-Host "   ‚ùå Error: $($_.Exception.Message)" -ForegroundColor Red
}

Write-Host "   GET /solicitudes (admin deber√≠a ver todas):" -ForegroundColor Yellow
try {
    $response = Invoke-WebRequest -Uri "$BaseUrl/solicitudes" -Headers $headers -TimeoutSec 5
    Write-Host "   ‚úÖ Respuesta recibida - Status: $($response.StatusCode)" -ForegroundColor Green
    Write-Host "   Contenido: $($response.Content.Substring(0, [Math]::Min(100, $response.Content.Length)))..." -ForegroundColor Gray
} catch {
    Write-Host "   ‚ùå Error: $($_.Exception.Message)" -ForegroundColor Red
}

Write-Host "   GET /usuarios/yo (admin):" -ForegroundColor Yellow
try {
    $response = Invoke-WebRequest -Uri "$BaseUrl/usuarios/yo" -Headers $headers -TimeoutSec 5
    Write-Host "   ‚úÖ Respuesta recibida - Status: $($response.StatusCode)" -ForegroundColor Green
    Write-Host "   Contenido: $($response.Content.Substring(0, [Math]::Min(100, $response.Content.Length)))..." -ForegroundColor Gray
} catch {
    Write-Host "   ‚ùå Error: $($_.Exception.Message)" -ForegroundColor Red
}

# ==============================================
# 4. PROBAR CON TOKEN DE CLIENTE
# ==============================================

Write-Host "`n4Ô∏è‚É£ Probando endpoints con token de CLIENTE:" -ForegroundColor Cyan

Write-Host "   GET /prestamos (cliente deber√≠a ver solo los suyos):" -ForegroundColor Yellow
$headers = @{ "Authorization" = "Bearer $ClienteToken" }
try {
    $response = Invoke-WebRequest -Uri "$BaseUrl/prestamos" -Headers $headers -TimeoutSec 5
    Write-Host "   ‚úÖ Respuesta recibida - Status: $($response.StatusCode)" -ForegroundColor Green
    Write-Host "   Contenido: $($response.Content.Substring(0, [Math]::Min(100, $response.Content.Length)))..." -ForegroundColor Gray
} catch {
    Write-Host "   ‚ùå Error: $($_.Exception.Message)" -ForegroundColor Red
}

Write-Host "   GET /solicitudes (cliente deber√≠a ver solo las suyas):" -ForegroundColor Yellow
try {
    $response = Invoke-WebRequest -Uri "$BaseUrl/solicitudes" -Headers $headers -TimeoutSec 5
    Write-Host "   ‚úÖ Respuesta recibida - Status: $($response.StatusCode)" -ForegroundColor Green
    Write-Host "   Contenido: $($response.Content.Substring(0, [Math]::Min(100, $response.Content.Length)))..." -ForegroundColor Gray
} catch {
    Write-Host "   ‚ùå Error: $($_.Exception.Message)" -ForegroundColor Red
}

Write-Host "   GET /usuarios/yo (cliente):" -ForegroundColor Yellow
try {
    $response = Invoke-WebRequest -Uri "$BaseUrl/usuarios/yo" -Headers $headers -TimeoutSec 5
    Write-Host "   ‚úÖ Respuesta recibida - Status: $($response.StatusCode)" -ForegroundColor Green
    Write-Host "   Contenido: $($response.Content.Substring(0, [Math]::Min(100, $response.Content.Length)))..." -ForegroundColor Gray
} catch {
    Write-Host "   ‚ùå Error: $($_.Exception.Message)" -ForegroundColor Red
}

# ==============================================
# 5. PROBAR CREAR SOLICITUD (CLIENTE)
# ==============================================

Write-Host "`n5Ô∏è‚É£ Probando crear solicitud con token de CLIENTE:" -ForegroundColor Cyan

Write-Host "   POST /solicitudes (cliente_id extra√≠do del JWT):" -ForegroundColor Yellow
$body = @{
    monto_solicitado = 150000
    plazo_meses = 18
    proposito = "Compra de veh√≠culo"
} | ConvertTo-Json

try {
    $response = Invoke-WebRequest -Uri "$BaseUrl/solicitudes" -Method POST -Headers $headers -Body $body -ContentType "application/json" -TimeoutSec 5
    Write-Host "   ‚úÖ Solicitud creada - Status: $($response.StatusCode)" -ForegroundColor Green
    Write-Host "   Contenido: $($response.Content.Substring(0, [Math]::Min(100, $response.Content.Length)))..." -ForegroundColor Gray
} catch {
    Write-Host "   ‚ùå Error: $($_.Exception.Message)" -ForegroundColor Red
}

# ==============================================
# 6. PROBAR ENDPOINTS DE SALUD
# ==============================================

Write-Host "`n6Ô∏è‚É£ Probando endpoints p√∫blicos:" -ForegroundColor Cyan

Write-Host "   GET /salud:" -ForegroundColor Yellow
try {
    $response = Invoke-WebRequest -Uri "$BaseUrl/salud" -TimeoutSec 5
    Write-Host "   ‚úÖ Respuesta recibida - Status: $($response.StatusCode)" -ForegroundColor Green
    Write-Host "   Contenido: $($response.Content.Substring(0, [Math]::Min(100, $response.Content.Length)))..." -ForegroundColor Gray
} catch {
    Write-Host "   ‚ùå Error: $($_.Exception.Message)" -ForegroundColor Red
}

Write-Host "   GET /docs (Swagger):" -ForegroundColor Yellow
try {
    $response = Invoke-WebRequest -Uri "$BaseUrl/docs" -TimeoutSec 5
    Write-Host "   ‚úÖ Swagger accesible - Status: $($response.StatusCode)" -ForegroundColor Green
} catch {
    Write-Host "   ‚ùå Error: $($_.Exception.Message)" -ForegroundColor Red
}

# ==============================================
# NOTAS
# ==============================================

Write-Host "`nüìù NOTAS DE SEGURIDAD:" -ForegroundColor Yellow
Write-Host "   ‚ö†Ô∏è  Los tokens en este script son PLACEHOLDERS y NO son v√°lidos" -ForegroundColor Gray
Write-Host "   üîê Para pruebas reales, usa tokens generados desde Supabase" -ForegroundColor Gray
Write-Host "   üõ°Ô∏è  Aseg√∫rate de que las pol√≠ticas RLS est√©n configuradas en Supabase" -ForegroundColor Gray
Write-Host "   üìä Los datos de prueba deben existir en la base de datos" -ForegroundColor Gray
Write-Host "   üö® NUNCA subas tokens reales a repositorios p√∫blicos" -ForegroundColor Red

Write-Host "`n‚úÖ Pruebas completadas!" -ForegroundColor Green
